# ============================================
# FinanceAICrews Nginx Gateway Configuration
# ============================================
# 
# 架构: Browser → Nginx(:80) → Frontend(:3000) / Backend(:8000)
#
# 关键点:
# 1. /api/ 请求转发到 FastAPI 后端
# 2. 其他请求转发到 Next.js 前端
# 3. 正确处理尾部斜杠 (Trailing Slash)
# 4. WebSocket 支持 (用于 SSE/热重载)
# ============================================

upstream frontend {
    server financeai_frontend:3000;
}

upstream backend {
    server financeai_backend:8000;
}

server {
    listen 80;
    server_name _;
    
    # 客户端请求体大小限制 (知识文件上传)
    client_max_body_size 50M;
    
    # Gzip 压缩
    gzip on;
    gzip_types text/plain text/css application/json application/javascript text/xml application/xml;
    gzip_min_length 1000;
    
    # ============================================
    # API 路由 → FastAPI Backend
    # ============================================
    # 关键: 使用 location /api/ (带尾部斜杠) 并在 proxy_pass 不带尾部斜杠
    # 这样 /api/v1/knowledge/marketplace 会正确转发到后端
    location /api/ {
        # proxy_pass 不带尾部斜杠，保留原始 URI
        proxy_pass http://backend;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # SSE (Server-Sent Events) 支持
        proxy_set_header Connection '';
        proxy_buffering off;
        proxy_cache off;
        
        # 超时设置 (AI 分析任务可能较长)
        proxy_connect_timeout 60s;
        proxy_send_timeout 300s;
        proxy_read_timeout 300s;
    }
    
    # ============================================
    # 健康检查端点
    # ============================================
    location /health {
        proxy_pass http://backend/health;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
    }
    
    # ============================================
    # 静态资源 (Next.js _next/static)
    # ============================================
    location /_next/static/ {
        proxy_pass http://frontend;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        
        # 静态资源缓存
        proxy_cache_valid 200 1d;
        add_header Cache-Control "public, max-age=31536000, immutable";
    }
    
    # ============================================
    # 其他所有请求 → Next.js Frontend
    # ============================================
    location / {
        proxy_pass http://frontend;
        
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket 支持 (Next.js HMR)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
    }
    
    # ============================================
    # 错误页面
    # ============================================
    error_page 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
        internal;
    }
}
